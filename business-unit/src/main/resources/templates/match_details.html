<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${selectedMatch != null ? selectedMatch.teamHome + ' vs ' + selectedMatch.teamAway : 'Detalle del Partido'}"></title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div class="page-container container">
    <aside class="sidebar">
        <h3>Otros Partidos</h3>
        <ul id="other-matches-sidebar-list">
            <li th:each="otherMatch : ${otherMatchesList}"
                th:id="'other-match-' + ${otherMatch.id}"
                th:classappend="${otherMatch.matchStatus != null and otherMatch.matchStatus.name() == 'LIVE'} ? 'live' : ''">
                <a th:href="@{/laliga/match/{matchId}(matchId=${otherMatch.id})}" class="other-match-entry">
                    <span class="other-match-teams" th:text="${otherMatch.teamHome + ' vs ' + otherMatch.teamAway}"></span>
                    <span class="other-match-time"
                          th:text="${(otherMatch.matchStatus != null and otherMatch.matchStatus.name() == 'LIVE') ?
                                    (otherMatch.liveTimeDisplay != null ? otherMatch.liveTimeDisplay : otherMatch.dateTimeString) :
                                    (otherMatch.dateTimeString != null ? otherMatch.dateTimeString : '--:--')}">
                    </span>
                </a>
            </li>
        </ul>
        <div id="no-other-matches-sidebar-message"
             th:styleappend="${(otherMatchesList == null or #lists.isEmpty(otherMatchesList)) ? '' : 'display:none;'}"
             style="padding: 5px 8px;">
            <p style="font-size: 0.9em; color: var(--secondary-color);">No hay otros partidos disponibles.</p>
        </div>

        <h3 style="margin-top: 20px;">Navegación</h3>
        <ul>
            <li><a th:href="@{/laliga/matches}"><i class="fas fa-list-ul"></i> Volver a la lista</a></li>
        </ul>
    </aside>

    <main class="main-content">
        <div th:if="${selectedMatch != null}">
            <div class="match-header" th:classappend="${selectedMatch.matchStatus != null and selectedMatch.matchStatus.name() == 'LIVE'} ? 'live' : ''">
                <div class="team-info">
                    <img th:src="${selectedMatch.homeTeamLogoUrl != null ? selectedMatch.homeTeamLogoUrl : (homeLogo != null ? homeLogo : 'https://via.placeholder.com/100?text=L')}"
                         th:alt="${selectedMatch.teamHome}" class="team-logo"/>
                    <p th:text="${selectedMatch.teamHome}"></p>
                </div>

                <div class="match-time-info">
                     <span class="status-label"
                           th:text="${(selectedMatch.matchStatus != null and selectedMatch.matchStatus.name() == 'LIVE') ? 'TIEMPO DE JUEGO' : 'FECHA / HORA'}">
                    </span>
                    <p id="detail-time">
                        <span th:if="${selectedMatch.matchStatus != null and selectedMatch.matchStatus.name() == 'LIVE'}"
                              th:text="${selectedMatch.liveTimeDisplay != null ? selectedMatch.liveTimeDisplay : (selectedMatch.dateTimeString != null ? selectedMatch.dateTimeString : 'En Vivo')}">
                        </span>
                        <span th:if="${selectedMatch.matchStatus == null or selectedMatch.matchStatus.name() != 'LIVE'}"
                              th:text="${selectedMatch.dateTimeString != null ? selectedMatch.dateTimeString : '--:--'}">
                        </span>
                    </p>
                </div>

                <div class="team-info">
                    <img th:src="${selectedMatch.awayTeamLogoUrl != null ? selectedMatch.awayTeamLogoUrl : (awayLogo != null ? awayLogo : 'https://via.placeholder.com/100?text=V')}"
                         th:alt="${selectedMatch.teamAway}" class="team-logo"/>
                    <p th:text="${selectedMatch.teamAway}"></p>
                </div>
            </div>

            <div class="odds-container">
                <div class="odd-box">
                    <span class="odd-label" th:text="${selectedMatch.teamHome}">LOCAL</span>
                    <span id="oddsHome" class="odd-value"
                          th:text="${selectedMatch.oddsHome != null ? #numbers.formatDecimal(selectedMatch.oddsHome,1,2) : 'N/A'}">1.00</span>
                </div>
                <div class="odd-box">
                    <span class="odd-label">EMPATE</span>
                    <span id="oddsDraw" class="odd-value"
                          th:text="${selectedMatch.oddsDraw != null ? #numbers.formatDecimal(selectedMatch.oddsDraw,1,2) : 'N/A'}">1.00</span>
                </div>
                <div class="odd-box">
                    <span class="odd-label" th:text="${selectedMatch.teamAway}">VISITANTE</span>
                    <span id="oddsAway" class="odd-value"
                          th:text="${selectedMatch.oddsAway != null ? #numbers.formatDecimal(selectedMatch.oddsAway,1,2) : 'N/A'}">1.00</span>
                </div>
            </div>

            <div class="additional-match-info-wrapper">
                <div class="odds-source-info" th:if="${selectedMatch.oddsSource != null}">
                    <span>Fuente Cuotas:</span>
                    <img th:src="@{/images/logos/betfair.png}" alt="Betfair Logo" class="odds-source-logo"/>
                    <span th:text="${selectedMatch.oddsSource}">Betfair</span>
                </div>

                <div class="match-venue-details">
                    <div id="stadium-info-item" class="venue-item"
                         th:styleappend="${selectedMatch.stadium == null ? 'display:none;' : ''}">
                        <i class="fas fa-landmark"></i>
                        <span class="venue-label">Estadio:</span>
                        <span id="matchStadium" class="venue-value" th:text="${selectedMatch.stadium}"></span>
                    </div>
                    <div id="referee-info-item" class="venue-item"
                         th:styleappend="${selectedMatch.referee == null ? 'display:none;' : ''}">
                        <i class="fas fa-user-tie"></i>
                        <span class="venue-label">Árbitro:</span>
                        <span id="matchReferee" class="venue-value" th:text="${selectedMatch.referee}"></span>
                    </div>
                </div>
            </div>
        </div>
        <div th:if="${selectedMatch == null}" class="no-matches-message">
            <i class="fas fa-exclamation-triangle"></i>
            <p>No se ha podido cargar la información del partido. Por favor, <a th:href="@{/laliga/matches}">vuelve a la lista de partidos</a>.</p>
        </div>
    </main>
</div>

<script th:if="${selectedMatch != null}" th:inline="javascript">
    /*<![CDATA[*/
    const selectedMatchIdDetails = /*[[${selectedMatch.id}]]*/ 'NONE';
    const matchDetailBaseUrlDetails = /*[[@{/laliga/match/}]]*/ '/laliga/match/';
    const sseStreamUrlDetailsPage = /*[[@{/matches/stream}]]*/ '/matches/stream';
    /*]]>*/

    if (selectedMatchIdDetails !== 'NONE') {
        const detailTimeLiveSpan = document.querySelector('#detail-time span:first-of-type'); // El span para LIVE
        const detailTimeScheduledSpan = document.querySelector('#detail-time span:last-of-type'); // El span para NO LIVE
        const statusLabelElement = document.querySelector('.match-time-info .status-label');
        const matchHeaderElement = document.querySelector('.match-header');

        const oddsHomeElement = document.getElementById('oddsHome');
        const oddsDrawElement = document.getElementById('oddsDraw');
        const oddsAwayElement = document.getElementById('oddsAway');

        const matchStadiumElement = document.getElementById('matchStadium');
        const stadiumInfoItem = document.getElementById('stadium-info-item');
        const matchRefereeElement = document.getElementById('matchReferee');
        const refereeInfoItem = document.getElementById('referee-info-item');


        const srcDetails = new EventSource(sseStreamUrlDetailsPage);

        srcDetails.onmessage = function(event) {
            const updatedMatchesAll = JSON.parse(event.data);

            const currentMatchData = updatedMatchesAll.find(m => m.id == selectedMatchIdDetails);
            if (currentMatchData) {
                // Asegurarse de que matchStatus sea un string para la comparación en JS
                const currentStatusStr = (currentMatchData.matchStatus && currentMatchData.matchStatus.name) ? currentMatchData.matchStatus.name : currentMatchData.matchStatus;
                let isLive = currentStatusStr === 'LIVE';

                if (statusLabelElement) statusLabelElement.textContent = isLive ? 'TIEMPO DE JUEGO' : 'FECHA / HORA';

                if (isLive) {
                    const liveText = currentMatchData.liveTimeDisplay || currentMatchData.dateTimeString || 'En Vivo';
                    if (detailTimeLiveSpan && detailTimeLiveSpan.textContent !== liveText) {
                        detailTimeLiveSpan.textContent = liveText;
                        applyHighlight(detailTimeLiveSpan);
                    }
                    if (detailTimeLiveSpan) detailTimeLiveSpan.style.display = '';
                    if (detailTimeScheduledSpan) detailTimeScheduledSpan.style.display = 'none';
                } else {
                    const scheduledText = currentMatchData.dateTimeString || '--:--';
                    if (detailTimeScheduledSpan && detailTimeScheduledSpan.textContent !== scheduledText) {
                        detailTimeScheduledSpan.textContent = scheduledText;
                        applyHighlight(detailTimeScheduledSpan);
                    }
                    if (detailTimeLiveSpan) detailTimeLiveSpan.style.display = 'none';
                    if (detailTimeScheduledSpan) detailTimeScheduledSpan.style.display = '';
                }

                if (matchHeaderElement) {
                    if (isLive) matchHeaderElement.classList.add('live');
                    else matchHeaderElement.classList.remove('live');
                }

                updateOddValue(oddsHomeElement, currentMatchData.oddsHome);
                updateOddValue(oddsDrawElement, currentMatchData.oddsDraw);
                updateOddValue(oddsAwayElement, currentMatchData.oddsAway);

                if (stadiumInfoItem && matchStadiumElement) {
                    const stadiumText = currentMatchData.stadium || '';
                    if (matchStadiumElement.textContent !== stadiumText) {
                        matchStadiumElement.textContent = stadiumText;
                        if(stadiumText) applyHighlight(stadiumInfoItem);
                    }
                    stadiumInfoItem.style.display = stadiumText ? 'flex' : 'none';
                }
                if (refereeInfoItem && matchRefereeElement) {
                    const refereeText = currentMatchData.referee || '';
                    if (matchRefereeElement.textContent !== refereeText) {
                        matchRefereeElement.textContent = refereeText;
                        if(refereeText) applyHighlight(refereeInfoItem);
                    }
                    refereeInfoItem.style.display = refereeText ? 'flex' : 'none';
                }
            }

            // Actualizar "Otros Partidos" en el sidebar
            const otherMatchesListContainer = document.getElementById('other-matches-sidebar-list');
            const noOtherMatchesMessageDiv = document.getElementById('no-other-matches-sidebar-message');
            if (otherMatchesListContainer && noOtherMatchesMessageDiv) {
                const relevantSidebarMatches = updatedMatchesAll.filter(m => {
                    const status = (m.matchStatus && m.matchStatus.name) ? m.matchStatus.name : m.matchStatus;
                    return m.id != selectedMatchIdDetails && (status === 'LIVE' || status === 'UPCOMING' || status === 'SCHEDULED');
                });

                otherMatchesListContainer.innerHTML = ''; // Limpiar lista actual

                if (relevantSidebarMatches.length === 0) {
                    noOtherMatchesMessageDiv.style.display = 'block';
                } else {
                    noOtherMatchesMessageDiv.style.display = 'none';
                    relevantSidebarMatches.forEach(om => {
                        const li = document.createElement('li');
                        li.id = `other-match-${om.id}`;
                        const status = (om.matchStatus && om.matchStatus.name) ? om.matchStatus.name : om.matchStatus;
                        if (status === 'LIVE') li.classList.add('live');

                        const a = document.createElement('a');
                        a.href = matchDetailBaseUrlDetails + om.id;
                        a.classList.add('other-match-entry');

                        const teamsSpan = document.createElement('span');
                        teamsSpan.classList.add('other-match-teams');
                        teamsSpan.textContent = `${om.teamHome || ''} vs ${om.teamAway || ''}`;

                        const timeSpan = document.createElement('span');
                        timeSpan.classList.add('other-match-time');
                        timeSpan.textContent = (status === 'LIVE') ?
                            (om.liveTimeDisplay || om.dateTimeString || 'En vivo') :
                            (om.dateTimeString || '--:--');

                        a.appendChild(teamsSpan);
                        a.appendChild(timeSpan);
                        li.appendChild(a);
                        otherMatchesListContainer.appendChild(li);
                    });
                }
            }
        };

        srcDetails.onerror = function(err) {
            console.error("EventSource failed (details):", err);
        };

        function updateOddValue(element, newValue) {
            if (element) {
                const formattedValue = newValue != null ? parseFloat(newValue).toFixed(2) : 'N/A';
                if (element.textContent !== formattedValue) {
                    element.textContent = formattedValue;
                    applyHighlight(element);
                }
            }
        }

        function applyHighlight(element) {
            if (element) {
                element.classList.add('highlight-update');
                setTimeout(() => { element.classList.remove('highlight-update'); }, 1000);
            }
        }
    }
</script>
</body>
</html>